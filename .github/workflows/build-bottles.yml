name: Build Bottles

on:
  push:
    branches: [master]
    paths:
      - "Formula/*.rb"
  workflow_dispatch:
    inputs:
      formula:
        description: "Formula to build (leave empty for all)"
        required: false
        default: ""

permissions:
  contents: write
  packages: write

jobs:
  detect-changes:
    runs-on: ubuntu-24.04
    outputs:
      formulas: ${{ steps.detect.outputs.formulas }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Detect changed formulas
        id: detect
        run: |
          if [ -n "${{ github.event.inputs.formula }}" ]; then
            FORMULAS='["${{ github.event.inputs.formula }}"]'
          else
            CHANGED=$(git diff --name-only HEAD~1 HEAD -- 'Formula/*.rb' | xargs -I {} basename {} .rb | jq -R -s -c 'split("\n") | map(select(length > 0))')
            if [ "$CHANGED" = "[]" ] || [ -z "$CHANGED" ]; then
              FORMULAS=$(find Formula -maxdepth 1 -name '*.rb' -printf '%f\n' | sed 's/\.rb$//' | jq -R -s -c 'split("\n") | map(select(length > 0))')
            else
              FORMULAS="$CHANGED"
            fi
          fi
          echo "formulas=$FORMULAS" >> "$GITHUB_OUTPUT"
          echo "Building formulas: $FORMULAS"

  build-bottle:
    needs: detect-changes
    if: needs.detect-changes.outputs.formulas != '[]' && github.actor != 'github-actions[bot]'
    runs-on: ubuntu-24.04
    strategy:
      fail-fast: false
      matrix:
        formula: ${{ fromJson(needs.detect-changes.outputs.formulas) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Homebrew
        uses: Homebrew/actions/setup-homebrew@master

      - name: Get formula info
        id: formula-info
        run: |
          FORMULA_FILE="Formula/${{ matrix.formula }}.rb"
          VERSION=$(grep -E '^\s*version\s+' "$FORMULA_FILE" | head -1 | sed 's/.*version\s*["\x27]\([^"\x27]*\)["\x27].*/\1/' || true)
          if [ -z "$VERSION" ]; then
            VERSION=$(grep -E '^\s*url\s+' "$FORMULA_FILE" | head -1 | grep -oP '[\d]+\.[\d]+\.[\d]+' | head -1 || true)
          fi
          if [ -z "$VERSION" ]; then
            VERSION="1.0.0"
          fi
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "Formula: ${{ matrix.formula }}, Version: $VERSION"

      - name: Install formula dependencies
        run: |
          brew tap ${{ github.repository }}
          brew install --only-dependencies ${{ github.repository_owner }}/${{ github.event.repository.name }}/${{ matrix.formula }} || true

      - name: Build bottle
        id: build
        run: |
          set -ex
          FORMULA="${{ github.repository_owner }}/${{ github.event.repository.name }}/${{ matrix.formula }}"

          brew install --build-bottle "$FORMULA"

          cd "$(brew --cache)"
          brew bottle --json --root-url="https://github.com/${{ github.repository }}/releases/download/${{ matrix.formula }}-${{ steps.formula-info.outputs.version }}" "$FORMULA"

          BOTTLE_FILE=$(find . -maxdepth 1 -name '*.bottle.tar.gz' -printf '%f\n' 2>/dev/null | head -1)
          BOTTLE_JSON=$(find . -maxdepth 1 -name '*.bottle.json' -printf '%f\n' 2>/dev/null | head -1)

          if [ -z "$BOTTLE_FILE" ]; then
            echo "No bottle file found!"
            exit 1
          fi

          FINAL_NAME="${{ matrix.formula }}-${{ steps.formula-info.outputs.version }}.x86_64_linux.bottle.tar.gz"
          mv "$BOTTLE_FILE" "$FINAL_NAME" || true
          BOTTLE_FILE="$FINAL_NAME"

          SHA256=$(sha256sum "$BOTTLE_FILE" | cut -d' ' -f1)

          {
            echo "bottle_file=$BOTTLE_FILE"
            echo "bottle_json=$BOTTLE_JSON"
            echo "bottle_path=$(brew --cache)/$BOTTLE_FILE"
            echo "sha256=$SHA256"
          } >> "$GITHUB_OUTPUT"

          echo "Bottle SHA256: $SHA256"

      - name: Upload bottle artifact
        uses: actions/upload-artifact@v4
        with:
          name: bottle-${{ matrix.formula }}
          path: ${{ steps.build.outputs.bottle_path }}
          retention-days: 7

      - name: Create/Update Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ matrix.formula }}-${{ steps.formula-info.outputs.version }}
          name: ${{ matrix.formula }} ${{ steps.formula-info.outputs.version }}
          body: |
            Bottle release for `${{ matrix.formula }}` version `${{ steps.formula-info.outputs.version }}`

            **SHA256:** `${{ steps.build.outputs.sha256 }}`

            Install with:
            ```bash
            brew install ${{ github.repository_owner }}/${{ github.event.repository.name }}/${{ matrix.formula }}
            ```
          files: ${{ steps.build.outputs.bottle_path }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update formula with bottle SHA256
        run: |
          VERSION="${{ steps.formula-info.outputs.version }}"
          ROOT_URL="https://github.com/${{ github.repository }}/releases/download/${{ matrix.formula }}-${VERSION}"

          python3 scripts/update-bottle.py \
            --formula "Formula/${{ matrix.formula }}.rb" \
            --sha256 "${{ steps.build.outputs.sha256 }}" \
            --root-url "$ROOT_URL"

          cat "Formula/${{ matrix.formula }}.rb"

      - name: Commit formula update
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add "Formula/${{ matrix.formula }}.rb"
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Update ${{ matrix.formula }} bottle SHA256 to ${{ steps.build.outputs.sha256 }}"
            git push
          fi

      - name: Output bottle info
        run: |
          {
            echo "## Bottle Build Summary"
            echo ""
            echo "| Property | Value |"
            echo "|----------|-------|"
            echo "| Formula | ${{ matrix.formula }} |"
            echo "| Version | ${{ steps.formula-info.outputs.version }} |"
            echo "| SHA256 | \`${{ steps.build.outputs.sha256 }}\` |"
            echo "| Release | ${{ matrix.formula }}-${{ steps.formula-info.outputs.version }} |"
            echo ""
            echo "Add this to your formula:"
            echo "\`\`\`ruby"
            echo "bottle do"
            echo "  root_url \"https://github.com/${{ github.repository }}/releases/download/${{ matrix.formula }}-${{ steps.formula-info.outputs.version }}\""
            echo "  sha256 cellar: :any_skip_relocation, x86_64_linux: \"${{ steps.build.outputs.sha256 }}\""
            echo "end"
            echo "\`\`\`"
          } >> "$GITHUB_STEP_SUMMARY"
